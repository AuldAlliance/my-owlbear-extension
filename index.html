<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Stats & Notes</title>
    <style>
        html { background: transparent !important; }
        body { 
            background: rgba(32, 33, 36, 0.2) !important; 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: white; font-family: sans-serif; padding: 12px; margin: 0; 
            display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-shrink: 0; }
        #status { font-size: 11px; color: #aaa; font-weight: bold; text-transform: uppercase; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 8px; flex-shrink: 0; }
        .tab-btn { 
            flex: 1; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #888; cursor: pointer; font-size: 9px; font-weight: bold; border-radius: 4px 4px 0 0;
            transition: all 0.2s ease;
        }
        .tab-btn.active-tab { background: rgba(255,255,255,0.1); color: white; border-bottom: 2px solid #2196F3; }

        .controls { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; margin-bottom: 12px; }
        #gmTools { display: flex; flex-direction: column; gap: 8px; border: 1px solid rgba(255, 255, 255, 0.1); padding: 8px; border-radius: 6px; background: rgba(0, 0, 0, 0.2); }
        .gm-action-row { display: flex; align-items: center; gap: 8px; }

        .eye-container { position: relative; width: 34px; height: 28px; flex-shrink: 0; }
        #privateCheck { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; margin: 0; }
        .eye-button { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .eye-button svg { width: 16px; height: 16px; fill: #bbb; }
        #privateCheck:checked + .eye-button { border-color: #f28b82; background: rgba(242, 139, 130, 0.1); }
        #privateCheck:checked + .eye-button svg { fill: #f28b82; }

        button { cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 10px; color: white; border: none; transition: background 0.2s; }
        #saveBtn { flex: 2; height: 26px; background: #2196F3; }
        #clearBtn { flex: 1; height: 26px; background: #f44336; }
        #popoutBtn { width: 34px; height: 26px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        #shareHandoutBtn { background: #4caf50; height: 26px; padding: 0 8px; display: none; }

        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; outline: none; }
        
        #contentArea { flex-grow: 1; position: relative; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; background: rgba(0,0,0,0.2); overflow: hidden; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; border: none; }
        .active { visibility: visible; }

        #notesArea { padding: 12px; box-sizing: border-box; color: #ddd; resize: none; font-family: inherit; font-size: 14px; background: transparent; width: 100%; height: 100%; border: none; outline: none; line-height: 1.4; }
        #handoutLayer { display: flex; align-items: center; justify-content: center; padding: 10px; box-sizing: border-box; }
        #handoutImg { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px; }
        .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-style: italic; text-align: center; padding: 20px; gap: 10px; }
    </style>
</head>
<body>
    <div class="header"><div id="status">Ready</div></div>

    <div class="tabs">
        <button id="tabUrl" class="tab-btn active-tab">URL / STATS</button>
        <button id="tabNotes" class="tab-btn">NOTES</button>
        <button id="tabHandout" class="tab-btn">HANDOUT</button>
    </div>
    
    <div class="controls">
        <div id="gmTools">
            <input type="text" id="urlInput" placeholder="URL">
            <div id="controlRow" class="gm-action-row">
                <div id="privateToggleContainer" class="eye-container" title="Toggle Private/Public">
                    <input type="checkbox" id="privateCheck" checked>
                    <div class="eye-button">
                        <svg class="eye-open" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                    </div>
                </div>
                <button id="saveBtn">Save</button>
                <button id="shareHandoutBtn" title="Push image to all players">Share</button>
                <button id="clearBtn">Clear</button>
                <button id="popoutBtn">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="contentArea">
        <iframe id="statsFrame" class="layer" style="background:white; width:100%; height:100%;"></iframe>
        <textarea id="notesArea" class="layer" placeholder="Type notes here..."></textarea>
        <div id="handoutLayer" class="layer"><img id="handoutImg" src="" alt="Handout"></div>
        <div id="noSelectionMsg" class="layer placeholder active">Select a token to begin.</div>
    </div>

    <script type="module">
        import OBR from "https://cdn.jsdelivr.net/npm/@owlbear-rodeo/sdk@latest/+esm";
        const ID = "com.auldalliance.stats-linker";
        const STORAGE_KEY = `${ID}_last_token_id`;
        const BROADCAST_ID = `${ID}/share_event`;

        OBR.onReady(async () => {
            const role = await OBR.player.getRole();
            const isGM = role === "GM";
            const input = document.getElementById('urlInput');
            const controlRow = document.getElementById('controlRow');
            const notesArea = document.getElementById('notesArea');
            const handoutImg = document.getElementById('handoutImg');
            const gmTools = document.getElementById('gmTools');
            const statsFrame = document.getElementById('statsFrame');
            const shareHandoutBtn = document.getElementById('shareHandoutBtn');
            const privateCheck = document.getElementById('privateCheck');
            const privateToggleContainer = document.getElementById('privateToggleContainer');
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            const popoutBtn = document.getElementById('popoutBtn');
            
            let currentTab = 'url';
            let currentMetadata = { url: "", note: "", handout: "", private: true };

            const switchTab = (tab) => {
                currentTab = tab;

                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active-tab'));
                const targetBtn = document.getElementById(`tab${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                if(targetBtn) targetBtn.classList.add('active-tab');

                const isNotes = tab === 'notes';
                const isHandout = tab === 'handout';

                if (isGM) {
                    input.style.display = isNotes ? "none" : "block";
                    controlRow.style.display = isNotes ? "none" : "flex";
                    shareHandoutBtn.style.display = isHandout ? "block" : "none";
                } else {
                    if (isHandout || isNotes) {
                        input.style.display = "none";
                        controlRow.style.display = "none";
                    } else {
                        input.style.display = "block";
                        controlRow.style.display = "flex";
                        saveBtn.style.display = "none";
                        clearBtn.style.display = "none";
                        privateToggleContainer.style.display = "none";
                        popoutBtn.style.display = "block";
                    }
                }

                input.value = (tab === 'handout') ? (currentMetadata.handout || "") : (currentMetadata.url || "");
                refreshUI();
            };

            const refreshUI = () => {
                const isPrivate = currentMetadata.private ?? true;
                const url = currentMetadata.url || "";
                const handout = currentMetadata.handout || "";

                if (!isGM) {
                    const urlTab = document.getElementById('tabUrl');
                    const notesTab = document.getElementById('tabNotes');
                    if (isPrivate) {
                        urlTab.style.display = "none";
                        notesTab.style.display = "none";
                        if (currentTab !== 'handout') return switchTab('handout');
                    } else {
                        urlTab.style.display = "block";
                        notesTab.style.display = "block";
                    }
                }

                if (currentTab === 'notes') {
                    showLayer('notesArea');
                } else if (currentTab === 'handout') {
                    if(handoutImg.src !== handout) handoutImg.src = handout;
                    showLayer('handoutLayer');
                } else if (url) {
                    const formattedUrl = url.startsWith('http') ? url : `https://${url}`;
                    // FIXED: Only refresh iframe if source changed
                    if (statsFrame.src !== formattedUrl) statsFrame.src = formattedUrl;
                    showLayer('statsFrame');
                } else {
                    showLayer('notesArea');
                }
            };

            const showLayer = (id) => {
                ['statsFrame', 'notesArea', 'handoutLayer', 'noSelectionMsg'].forEach(l => {
                    document.getElementById(l).classList.toggle('active', l === id);
                });
            };

            const syncFromToken = async (selection) => {
                let tokenId = selection?.[0] || localStorage.getItem(STORAGE_KEY);
                if (!tokenId) {
                    currentMetadata = { url: "", note: "", handout: "", private: true };
                    return showLayer('noSelectionMsg');
                }

                const items = await OBR.scene.items.getItems([tokenId]);
                const token = items[0];
                if (token) {
                    localStorage.setItem(STORAGE_KEY, tokenId);
                    currentMetadata = {
                        url: token.metadata[`${ID}/url`] || "",
                        note: token.metadata[`${ID}/note`] || "",
                        handout: token.metadata[`${ID}/handout`] || "",
                        private: token.metadata[`${ID}/private`] ?? true
                    };
                    
                    if (isGM) {
                        if (document.activeElement !== input) {
                            input.value = (currentTab === 'handout') ? currentMetadata.handout : currentMetadata.url;
                        }
                        privateCheck.checked = currentMetadata.private;
                    }
                    if (document.activeElement !== notesArea) notesArea.value = currentMetadata.note;
                    refreshUI();
                }
            };

            notesArea.onblur = async () => {
                const tokenId = localStorage.getItem(STORAGE_KEY);
                if (!tokenId || !isGM) return; // Only GM updates metadata via notes
                await OBR.scene.items.updateItems([tokenId], (items) => {
                    for (let item of items) {
                        item.metadata[`${ID}/note`] = notesArea.value;
                    }
                });
            };

            document.getElementById('tabUrl').onclick = () => switchTab('url');
            document.getElementById('tabNotes').onclick = () => switchTab('notes');
            document.getElementById('tabHandout').onclick = () => switchTab('handout');
            
            popoutBtn.onclick = () => {
                const url = input.value.trim() || currentMetadata.url;
                if (url) window.open(url.startsWith('http') ? url : `https://${url}`, "_blank", "width=600,height=700");
                OBR.action.close(); // Close the sidebar/popover
            };

            saveBtn.onclick = async () => {
                const tokenId = localStorage.getItem(STORAGE_KEY);
                if (!tokenId) return;
                await OBR.scene.items.updateItems([tokenId], (items) => {
                    for (let item of items) {
                        if (currentTab === 'url')
                        {
                            let url = input.value.trim();
                            // 5e.tools Bestiary link helper
                            if (url.includes("bestiary.html#")) {
                                url = decodeURIComponent(url).replace("bestiary.html#", "bestiary/").replace(/ /g, "-").replace(/_/g, "-") + ".html";
                                OBR.notification.show(url);
                                item.metadata[`${ID}/url`] = url;
                            }
                            else
                            {
                                item.metadata[`${ID}/url`] = input.value;
                            }
                        }
                        if (currentTab === 'handout') item.metadata[`${ID}/handout`] = input.value;
                        item.metadata[`${ID}/note`] = notesArea.value;
                        item.metadata[`${ID}/private`] = privateCheck.checked;
                    }
                });
                OBR.notification.show("Saved!");
            };

            OBR.broadcast.onMessage(BROADCAST_ID, (e) => window.open(e.data.url, "_blank", "width=600,height=700"));
            shareHandoutBtn.onclick = () => OBR.broadcast.sendMessage(BROADCAST_ID, { url: input.value });
            
            // Listen for changes but avoid unnecessary heavy refreshes
            OBR.player.onChange(p => syncFromToken(p.selection));
            OBR.scene.items.onChange(items => {
               const activeId = localStorage.getItem(STORAGE_KEY);
               if (activeId) syncFromToken([activeId]);
            });

            syncFromToken(await OBR.player.getSelection());
            switchTab('url');
        });
    </script>
</body>
</html>

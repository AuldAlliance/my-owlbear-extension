const ID = "com.auldalliance.token-linker"; // Unified ID
const OBR = window.OBR;

// 1. Check if the SDK actually loaded
if (!OBR) {
    console.error("OBR SDK failed to load from the CDN!");
    document.getElementById('status').innerText = "Error: SDK Not Found";
}

OBR.onReady(async () => {
    console.log("OBR is Ready and Connected!");
    const status = document.getElementById('status');
    const showBtn = document.getElementById('showStatsBtn');
    const input = document.getElementById('urlInput');

    status.innerText = "Connected: Select a token";

    // 2. Handle Selection Changes
    OBR.player.onChange(async (player) => {
        console.log("Selection changed:", player.selection);
        
        if (player.selection && player.selection.length > 0) {
            const items = await OBR.scene.items.getItems(player.selection);
            const token = items[0];
            
            // Check if it's actually a character/token, not a drawing
            if (token) {
                const savedUrl = token.metadata[`${ID}/statsUrl`];
                input.value = savedUrl || "";
                showBtn.disabled = !savedUrl;
                status.innerText = `Selected: ${token.name}`;
            }
        } else {
            status.innerText = "Nothing selected";
            showBtn.disabled = true;
            input.value = "";
        }
    });

    // 3. Save Logic
    document.getElementById('saveUrlBtn').onclick = async () => {
        const selection = await OBR.player.getSelection();
        if (selection.length === 0) return OBR.notification.show("Select a token first!");

        await OBR.scene.items.updateItems(selection, (items) => {
            for (let item of items) {
                item.metadata[`${ID}/statsUrl`] = input.value.trim();
            }
        });
        
        OBR.notification.show("URL Saved to Token");
        showBtn.disabled = !input.value.trim();
    };

    // 4. Show Logic
    showBtn.onclick = () => {
        const url = input.value.trim();
        if (url) window.open(url, '_blank');
    };
});

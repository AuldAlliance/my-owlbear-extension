<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Token Stats & Notes</title>
    <style>
        html { background: transparent !important; }
        body { 
            background: rgba(32, 33, 36, 0.2) !important; 
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            color: white; font-family: sans-serif; padding: 12px; margin: 0; 
            display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; overflow: hidden;
        }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; flex-shrink: 0; }
        #status { font-size: 11px; color: #aaa; font-weight: bold; text-transform: uppercase; }
        
        .tabs { display: flex; gap: 4px; margin-bottom: 8px; flex-shrink: 0; }
        .tab-btn { 
            flex: 1; padding: 8px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); 
            color: #888; cursor: pointer; font-size: 10px; font-weight: bold; border-radius: 4px 4px 0 0;
            transition: all 0.2s ease;
        }
        .tab-btn.active-tab { background: rgba(255,255,255,0.1); color: white; border-bottom: 2px solid #2196F3; }

        .controls { display: flex; flex-direction: column; gap: 8px; flex-shrink: 0; margin-bottom: 12px; }
        #gmTools { display: none; flex-direction: column; gap: 8px; border: 1px solid rgba(255, 255, 255, 0.1); padding: 8px; border-radius: 6px; background: rgba(0, 0, 0, 0.2); }
        .gm-action-row { display: flex; align-items: center; gap: 8px; }

        .eye-container { position: relative; width: 34px; height: 28px; flex-shrink: 0; }
        #privateCheck { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; z-index: 2; margin: 0; }
        .eye-button { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; display: flex; align-items: center; justify-content: center; pointer-events: none; }
        .eye-button svg { width: 16px; height: 16px; fill: #bbb; }
        #privateCheck:checked + .eye-button { border-color: #f28b82; background: rgba(242, 139, 130, 0.1); }
        #privateCheck:checked + .eye-button svg { fill: #f28b82; }
        #privateCheck:checked + .eye-button .eye-open { display: none; }
        #privateCheck:not(:checked) + .eye-button .eye-closed { display: none; }

        button { cursor: pointer; border-radius: 4px; font-weight: bold; text-transform: uppercase; font-size: 10px; color: white; border: none; transition: background 0.2s; }
        #saveBtn { flex: 2; height: 26px; background: #2196F3; }
        #clearBtn { flex: 1; height: 26px; background: #f44336; }
        #popoutBtn { width: 34px; height: 26px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }

        input[type="text"] { width: 100%; padding: 8px; box-sizing: border-box; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.1); border-radius: 4px; outline: none; }
        
        #contentArea { flex-grow: 1; position: relative; border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 4px; background: rgba(0,0,0,0.2); overflow: hidden; }
        .layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; visibility: hidden; border: none; }
        .active { visibility: visible; }

        iframe { background: white; width: 100%; height: 100%; }
        #notesArea { padding: 12px; box-sizing: border-box; color: #ddd; resize: none; font-family: inherit; font-size: 14px; background: transparent; width: 100%; height: 100%; border: none; outline: none; line-height: 1.4; }
        .placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-style: italic; text-align: center; padding: 20px; gap: 10px; }
        .icon-large { font-size: 30px; opacity: 0.3; }
        .error-btn { margin-top: 10px; padding: 8px 15px; background: #2196F3; color: white; border-radius: 4px; font-size: 10px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="header"><div id="status">Ready</div></div>

    <div class="tabs">
        <button id="tabUrl" class="tab-btn active-tab">URL / STATS</button>
        <button id="tabNotes" class="tab-btn">NOTES</button>
    </div>
    
    <div class="controls">
        <div id="gmTools">
            <input type="text" id="urlInput" placeholder="URL (Stats or Image)">
            <div class="gm-action-row">
                <div class="eye-container" title="Toggle Private/Public">
                    <input type="checkbox" id="privateCheck" checked>
                    <div class="eye-button">
                        <svg class="eye-open" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
                        <svg class="eye-closed" viewBox="0 0 24 24"><path d="M12 7c2.76 0 5 2.24 5 5 0 .65-.13 1.26-.36 1.82l2.92 2.92c1.51-1.26 2.7-2.89 3.44-4.74-1.73-4.39-6-7.5-11-7.5-1.4 0-2.74.25-3.98.7l2.16 2.16C10.74 7.13 11.35 7 12 7zM2 4.27l2.28 2.28.46.46C3.08 8.3 1.78 10.02 1 12c1.73 4.39 6 7.5 11 7.5 1.55 0 3.03-.3 4.38-.84l.42.42L19.73 22 21 20.73 3.27 3 2 4.27zM7.53 9.8l1.55 1.55c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3 .22 0 .44-.03.65-.08l1.55 1.55c-.67.33-1.41.53-2.2.53-2.76 0-5-2.24-5-5 0-.79.2-1.53.53-2.2zm4.31-.78l3.15 3.15.02-.17c0-1.66-1.34-3-3-3l-.17.02z"/></svg>
                    </div>
                </div>
                <button id="saveBtn">Save</button>
                <button id="clearBtn">Clear</button>
                <button id="popoutBtn" title="Open Floating Window">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>
                </button>
            </div>
        </div>
    </div>

    <div id="contentArea">
        <iframe id="statsFrame" class="layer"></iframe>
        <textarea id="notesArea" class="layer" placeholder="Type notes here..."></textarea>
        <div id="noSelectionMsg" class="layer placeholder active">Select a token to begin.</div>
        <div id="secretMsg" class="layer placeholder">
            <div class="icon-large">üîí</div>
            <div>Information hidden by GM</div>
        </div>
        <div id="errorMsg" class="layer placeholder">
            <div class="icon-large">‚ö†Ô∏è</div>
            <div style="color: #f28b82; font-weight: bold;">Frame Support Restricted</div>
            <div style="font-size: 10px; margin-top: 5px; opacity: 0.8;">News and official D&D sites must be opened in a separate window.</div>
            <button id="errorPopBtn" class="error-btn">OPEN FLOATING WINDOW</button>
        </div>
    </div>

    <script type="module">
        import OBR from "https://cdn.jsdelivr.net/npm/@owlbear-rodeo/sdk@latest/+esm";
        const ID = "com.auldalliance.stats-linker";
        const STORAGE_KEY = `${ID}_last_token_id`;

        OBR.onReady(async () => {
            const role = await OBR.player.getRole();
            const isGM = role === "GM";
            const gmTools = document.getElementById('gmTools');
            const status = document.getElementById('status');
            const saveBtn = document.getElementById('saveBtn');
            const clearBtn = document.getElementById('clearBtn');
            const popoutBtn = document.getElementById('popoutBtn');
            const errorPopBtn = document.getElementById('errorPopBtn');
            const input = document.getElementById('urlInput');
            const privateCheck = document.getElementById('privateCheck');
            const statsFrame = document.getElementById('statsFrame');
            const notesArea = document.getElementById('notesArea');
            const contentArea = document.getElementById('contentArea');
            
            let loadTimeout;
            let currentTab = 'url'; 

            gmTools.style.display = "flex";
            if (!isGM) document.querySelector('.eye-container').style.display = "none";

            const showLayer = (activeId) => {
                ['statsFrame', 'notesArea', 'noSelectionMsg', 'secretMsg', 'errorMsg'].forEach(id => {
                    document.getElementById(id).classList.toggle('active', id === activeId);
                });
            };

            const updateIframe = (url, force = false) => {
                if (!url) return;
                const fullUrl = url.startsWith('http') ? url : `https://${url}`;
                
                // If it's a different URL or we are forcing a refresh
                if (force || statsFrame.src.replace(/\/$/, "") !== fullUrl.replace(/\/$/, "")) {
                    showLayer('statsFrame');
                    clearTimeout(loadTimeout);
                    
                    // Momentarily clear to trigger a fresh load
                    if (force) statsFrame.src = "about:blank";
                    
                    loadTimeout = setTimeout(() => {
                        if(document.getElementById('statsFrame').classList.contains('active')) {
                            showLayer('errorMsg');
                        }
                    }, 3500);
                    statsFrame.src = fullUrl;
                } else {
                    showLayer('statsFrame');
                }
            };

            const switchTab = (tab) => {
                currentTab = tab;
                document.getElementById('tabUrl').classList.toggle('active-tab', tab === 'url');
                document.getElementById('tabNotes').classList.toggle('active-tab', tab === 'notes');
                input.style.display = tab === 'url' ? 'block' : 'none';

                const tokenId = localStorage.getItem(STORAGE_KEY);
                if (tokenId) {
                    if (tab === 'notes') {
                        showLayer('notesArea');
                    } else {
                        const url = input.value.trim();
                        if (url) updateIframe(url, true); else showLayer('notesArea');
                    }
                }
            };

            document.getElementById('tabUrl').onclick = () => switchTab('url');
            document.getElementById('tabNotes').onclick = () => switchTab('notes');

         const openFloatingWindow = () => {
    const url = input.value.trim();
    if (!url) return;
    const fullUrl = url.startsWith('http') ? url : `https://${url}`;

    // Get the position of the content inside the extension
    const rect = contentArea.getBoundingClientRect();

    /**
     * Logic:
     * 1. window.screenX/Y = Position of the Extension window on your monitor.
     * 2. rect.left/top = Position of the iframe content inside that window.
     * 3. Math.max handles cases where screenX might be 0 but the window is actually open.
     */
    let left = window.screenX + rect.left;
    let top = window.screenY + rect.top;

    // Fallback: If the browser is sandboxed (reporting 0,0), center it on the screen instead.
    if (window.screenX === 0 && window.screenY === 0) {
        left = (screen.width / 2) - (rect.width / 2);
        top = (screen.height / 2) - (rect.height / 2);
    }

    const w = 450;
    const h = 650;

    const features = `width=${w},height=${h},left=${left},top=${top},menubar=no,toolbar=no,location=no,status=no`;
    
    // We use '_blank' to ensure the browser calculates a fresh position every time
    const popup = window.open(fullUrl, "_blank", features);

   if (popup && !popup.closed) {
        // --- ADD THIS LINE BELOW ---
        OBR.action.close(); 
    } else {
        OBR.notification.show("Popup blocked. Please check browser settings.");
    }
};

            popoutBtn.onclick = openFloatingWindow;
            errorPopBtn.onclick = openFloatingWindow;
            statsFrame.onload = () => clearTimeout(loadTimeout);

            const syncView = async (selection) => {
                let tokenId = (selection?.length > 0) ? selection[0] : localStorage.getItem(STORAGE_KEY);
                if (!tokenId) { 
                    status.innerText = "Ready"; 
                    return showLayer('noSelectionMsg'); 
                }

                const items = await OBR.scene.items.getItems([tokenId]);
                const token = items[0];
                
                if (token) {
                    localStorage.setItem(STORAGE_KEY, tokenId);
                    const url = token.metadata[`${ID}/url`] || "";
                    const note = token.metadata[`${ID}/note`] || "";
                    const isPrivate = token.metadata[`${ID}/private`] ?? true;

                    status.innerText = token.text?.plainText || "";                    
                    input.value = url;
                    notesArea.value = note;
                    if (isGM) privateCheck.checked = isPrivate;

                    if (isPrivate && !isGM) {
                        gmTools.style.visibility = "hidden";
                        return showLayer('secretMsg');
                    }
                    gmTools.style.visibility = "visible";

                    if (currentTab === 'notes') {
                        showLayer('notesArea');
                    } else if (url) {
                        updateIframe(url, false); // false here to avoid infinite reload loop
                    } else {
                        showLayer('notesArea');
                    }
                } else {
                    localStorage.removeItem(STORAGE_KEY);
                    status.innerText = "Ready";
                    showLayer('noSelectionMsg');
                }
            };

            OBR.player.onChange((p) => { if (p.selection) syncView(p.selection); });
            OBR.scene.items.onChange(async () => syncView(await OBR.player.getSelection()));

            saveBtn.onclick = async () => {
                const currentSelection = await OBR.player.getSelection();
                const tokenId = currentSelection?.[0] || localStorage.getItem(STORAGE_KEY);
                if (!tokenId) return OBR.notification.show("Select a token first!");

                let url = input.value.trim();
                // 5e.tools Bestiary link helper
                if (url.includes("bestiary.html#")) {
                    url = decodeURIComponent(url).replace("bestiary.html#", "bestiary/").replace(/ /g, "-").replace(/_/g, "-") + ".html";
                    OBR.notification.show(url);
                }  
                
                await OBR.scene.items.updateItems([tokenId], (items) => {
                    for (let item of items) {
                        item.metadata[`${ID}/url`] = url;//input.value.trim();
                        item.metadata[`${ID}/note`] = notesArea.value;
                        if (isGM) item.metadata[`${ID}/private`] = privateCheck.checked;
                    }
                });
                
                OBR.notification.show("Saved!");
            };

            clearBtn.onclick = async () => {
                const currentSelection = await OBR.player.getSelection();
                const tokenId = currentSelection?.[0] || localStorage.getItem(STORAGE_KEY);
                if (!tokenId) return;

                await OBR.scene.items.updateItems([tokenId], (items) => {
                    for (let item of items) {
                        if (currentTab === 'url') {
                            item.metadata[`${ID}/url`] = "";
                            input.value = "";
                        } else {
                            item.metadata[`${ID}/note`] = "";
                            notesArea.value = "";
                        }
                        if (!item.metadata[`${ID}/url`] && !item.metadata[`${ID}/note`]) {
                            if (isGM) item.metadata[`${ID}/private`] = false;
                        }
                    }
                });
                OBR.notification.show(`Cleared ${currentTab === 'url' ? 'URL' : 'Notes'}`);
                syncView([tokenId]);
            };

            syncView(await OBR.player.getSelection());
        });
    </script>
</body>
</html>
